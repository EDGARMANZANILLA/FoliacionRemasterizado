@model Dictionary<int, string>


@{
    ViewBag.Icono = "fas fa-check-double";
    ViewBag.Title = "Finalizar una referencia de Cancelaciones";


}


<div class="margenSection row">

    <h4 class="col-12 text-center text-uppercase"> FINALIZAR UNA REFERENCIA DE CANCELACION: </h4>




    <div class="col-12 offset-md-3 col-md-6 text-center">
        <div class="form-group">
            <br />
            <select class="form-control" id="refeCancelSeleccionada" required>
                <option value="" disabled selected>Seleccione una referencia...</option>
                @foreach (var nuevoregistro in Model)
                {
                    <option value="@nuevoregistro.Key">@nuevoregistro.Value </option>
                }
            </select>
        </div>
    </div>



    <div class="col-12 text-center">
        <br />
        <button type="button" class="btn btn-lg btn-success" onclick=" VerDetallesReferenciaCancelacion()"><i class="far fa-arrow-alt-circle-right"></i> CONTINUAR <i class="far fa-arrow-alt-circle-right"></i></button>

    </div>


</div>



<!-- Cascaron de tabla para luego llenarla con datos desde la DB -->
<div class="margenSection">
    <div class="table-responsive">

        <div id="TablaDetalleReferenciaCancelado">

            <table id="InfoReferencia" class='table table-striped table-bordered table-hover' style="display:none">
                <caption class="text-uppercase">Referencia </caption>
                <thead class="tabla">
                    <tr class="text-center text-uppercase">

                        <th>Detalless </th>
                    </tr>
                </thead>


            </table>

        </div>
    </div>

    <div class="col-12 text-center" id="divBtnCancelar" style="display:none">
        <br />
        <button id="Finalizar" type="button" class="btn btn-lg btn-success" onclick="#"><i class="far fa-arrow-alt-circle-right"></i> FINALIZAR <i class="far fa-arrow-alt-circle-right"></i></button>

    </div>

</div>


 @*Modal para cargar una forma de pago a una referencia para su foliacion*@   
<!--<div class="modal fade" id="DetalleReferenciaCancelados" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog modal-xl">
        <div class="modal-content">-->
            @*<div class="modal-header">
                    <h4 class="modal-title col-11 text-capitalize text-center">AGREGAR UNA FORMA DE PAGO A UN NUMERO DE REFERENCIA DE CANCELACION</h4>
                    <button type="button" class="close btn-primary" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>*@
            <!--<div class="modal-body">




                 Cascaron de tabla para luego llenarla con datos desde la DB 
                <div class="margenSection">
                    <div class="table-responsive">

                        <div id="TablaDetalleReferenciaCancelado">

                            <table id="InfoReferencia" class='table table-striped table-bordered table-hover' style="display:none">
                                <caption class="text-uppercase">Referencia </caption>
                                <thead class="tabla">
                                    <tr class="text-center text-uppercase">

                                        <th>Detalless </th>
                                    </tr>
                                </thead>


                            </table>

                        </div>
                    </div>
                </div>



            </div>
            <div class="modal-footer">


                <button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>

            </div>
        </div>
    </div>
</div>-->














<script>
    function Dibujar_TablaDetalleReferenciaCancelado(NumeroReferencia) {
        $("#TablaDetalleReferenciaCancelado").append(

            "<table id='InfoReferencia'  class='margenSection table table-striped display table-bordered table-hover' cellspacing='0'  style='width:100%'>" +
            " <caption class='text-uppercase'>Detalle ReFerencia " + NumeroReferencia + "</caption>"
            + "<thead class='tabla'>" +

            "<tr class='text-center text-uppercase'>" +


            "<th>Id</th>" +
            "<th>IdNom</th>" +
            "<th>Quicena</th>" +
            "<th>Ref </th>" +
            "<th>Nomina</th>" +
            "<th>Deleg</th>" +
            "<th>Part</th>" +
            "<th>Es PA</th>" +
            "<th>Beneficiario</th>" +
            "<th>Num</th>" +
            "<th>Folio</th>" +
            "<th>Liquido</th>" +
            "<th>CFDI</th>" +
            "<th>Banco</th>" +
            "<th>Cta Banco</th>" +
            "<th></th>" +



            "</tr>" +
            "</thead>" +
            "</table>"

            
        );
    };

    let tblDetalleReferencia;
    function Pintar_TablaDetalleReferenciaCancelado(datos) {
         tblDetalleReferencia = $('#InfoReferencia').DataTable({
                                "ordering": true,
                                "info": false,
                                "searching": true,
                                "paging": true,
                                "lengthMenu": [15, 25, 50],
                                "language":
                                {
                                    "processing": "Procesando...",
                                    "lengthMenu": "Mostrar _MENU_ registros",
                                    "zeroRecords": "No se encontraron resultados",
                                    "emptyTable": "Ningún dato disponible en esta tabla",
                                    "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                                    "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                                    "search": "Buscar:",
                                    "info": "Mostrando de _START_ a _END_ de _TOTAL_ entradas",
                                    "paginate": {
                                        "first": "Primero",
                                        "last": "Último",
                                        "next": "Siguiente",
                                        "previous": "Anterior"
                                    }
                                },
                                "data": datos,
                                "columns": [

                                    { "data": "Id" },
                                    { "data": "IdNom" },
                                    { "data": "Quicena" },
                                    { "data": "ReferenciaOriginal" },
                                    { "data": "Nomina" },
                                    { "data": "Delegacion" },
                                    { "data": "Partida" },
                                    { "data": "EsPena" },
                                    { "data": "Nombre" },
                                    { "data": "Num" },
                                    { "data": "Folio" },
                                    { "data": "Liquido" },
                                    { "data": "CFDI" },
                                    { "data": "Banco" },
                                    { "data": "CTA_Bancaria" },
                                    {
                                        "render": function (data, type, row) {
                                            let Id = row.IdRegistro;
                                            //console.log("eeeeee"+da);
                                            return '<a  class="eliminar btn btn-success" > Remover <i class="fas fa-recycle"></i></a>';
                                        }


                                    }
                
                                ],

                                "order": [[0, 'desc']]

                            });

    };



    let arrayDeCadenas;
    function VerDetallesReferenciaCancelacion() {


        const SeleccionRefeCancelada = document.getElementById("refeCancelSeleccionada");

        let textoDelSelect = SeleccionRefeCancelada.options[SeleccionRefeCancelada.selectedIndex].text;
        arrayDeCadenas = null;
         arrayDeCadenas = textoDelSelect.split("||");



        if (SeleccionRefeCancelada.selectedIndex) {

            MensajeCargando();

            let enviarIdReferencia = "{'IdReferencia':'" + SeleccionRefeCancelada.value + "'}";


            $.ajax({
                url: 'ObtnerDetallesDentroReferencia/FinalizarReferencia_Cancelados',
                data: enviarIdReferencia,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                success: function (response) {



                    if (response.Bandera) {


                        $('#TablaDetalleReferenciaCancelado').empty();
                        Dibujar_TablaDetalleReferenciaCancelado(arrayDeCadenas[0].trim());
                        Pintar_TablaDetalleReferenciaCancelado(response.ListaDatos);


                        document.getElementById("divBtnCancelar").style.display = "block";
                        $('#DetalleReferenciaCancelados').modal('show');


                    } else {

                        // existeReferencia.style.display = "none";

                        document.getElementById("divBtnCancelar").style.display = "none";
                        $('#DetalleReferenciaCancelados').modal('hide');
                    }

                    OcultarMensajeCargando();

                }, error: function (jqXHR, textStatus) {
                    MensajeErrorSweet("Ocurrio un error intente de nuevo " + textStatus)
                    OcultarMensajeCargando();
                }
            });
















        } else {
            MensajeErrorSweet("Seleccione una referencia para continuar", "No se selecciono ninguna opcion");
        }




    }









        
    //}

    $(document).on("click", ".eliminar", function () {




        let datoAEliminar = null;
        datoAEliminar = tblDetalleReferencia.row($(this).parents("tr")).data();


        console.log(datoAEliminar);
        console.log("Registro : "+datoAEliminar.IdRegistro);



        Swal.fire({
            title: '¿ESTA SEGURO DE REMOVER LA FORMA DE PAGO '+datoAEliminar.Folio+' DE LA REFERENCIA '+arrayDeCadenas[0].trim()+'?',
            text: "¡Ya no se contemplara esta forma de pago para su cancelacion hasta que sea agregada nuevamente!",
            icon: 'warning',

            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#17a2b8',
            confirmButtonText: 'Remover',
            cancelButtonText: `Salir `

        }).then((result) => {
            if (result.isConfirmed) {

                 MensajeCargando();

                tblDetalleReferencia.row($(this).parents("tr")).remove().draw();

                let enviarIdReferenciaARemover = "{'IdRegistroRemoverReferencia':'"+datoAEliminar.IdRegistro+"'}";


                $.ajax({
                    url: 'FinalizarReferencia_Cancelados/RemoverNumeroReferenciaCancelacionDeUnIdRegistro',
                    data: enviarIdReferenciaARemover,
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {



                        if (response.NumeroMensaje == 8) {

                            MensajeCorrectoSweet(response.Mensaje);

                        } else {

                            // existeReferencia.style.display = "none";
                            MensajeErrorSweet(response.solucion, response.Mensaje)

                        }

                        OcultarMensajeCargando();

                    }, error: function (jqXHR, textStatus) {
                        MensajeErrorSweet("Ocurrio un error intente de nuevo " + textStatus)
                        OcultarMensajeCargando();
                    }
                });



            


            } else if (result.dismiss) {
                MensajeInformacionSweet("No se realizara ningún cambio");

            }



        })







    });



    




</script>