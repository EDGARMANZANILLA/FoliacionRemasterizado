@model  Dictionary<int, string>


<!-- Vista del pagomatico-->
<seccion id="VistaPagomatico" class="margenSection  card col-12  offset-md-2 col-md-8 text-center" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">

    <div class="margenSection row">

        <div class="btn-block">
            <h5>QUINCENA A FOLIAR EN PAGOMATICO</h5>
            <h5 id="QuincenaPagoMatico" class="azul">@ViewBag.NumeroQuincena</h5>
            <br />
        </div>

        <div class=" col-12 offset-md-3 col-md-6 text-center">
            <form>
                <label> Selecciona una opcion : </label>
                <div>
                    <label class="btn  btn-outline-primary ">
                        <input id="checkNomina" type="checkbox" autocomplete="off"> &nbsp Por Nomina &nbsp
                    </label>
                    <label class="btn  btn-outline-primary ">
                        <input id="checkTodasNominas" type="checkbox" autocomplete="off">&nbsp Todas las Nominas
                    </label>

                </div>
            </form>
            <br />
        </div>

        <div class="col-12 offset-md-1 col-md-10 text-center">
            <div class="form-group">
                <select class="form-control " id="SeleccionarNominaFoliar" required style="display: none;  ">
                    <option value="" disabled selected>Selecciona una Nomina...</option>
                    @foreach (var nuevaNomina in Model)
                    {

                        <option value="@nuevaNomina.Key">@nuevaNomina.Value </option>
                    }
                </select>
            </div>
        </div>



    </div>




    <div class="col-12 text-center">
        <button id="Revisar" type="button" class="btn btn-lg btn-success"> <i class="far fa-eye"></i>  Verificar  </i></button>
        <button id="RealizarFoliacion" type="button" class="btn btn-lg btn-success"><i class="fas fa-check-double"></i>  Foliar  <i class="fas fa-check-double"></i></button>

    </div>

    <br>


    <hr class="linea" />

    <!-- Cascaron de tabla para luego llenarla con datos desde la DB -->
    <div class="margenSection" id="DetalleAsignacion">
        <div class="table-responsive">

            <div id="TablaActualizada">

                <table id="AsignarFormas" class='table table-striped table-bordered table-hover' style="display: none;">
                    <caption class="text-uppercase"> Detalles o problemas con nominassss </caption>
                    <thead class="tabla">
                        <tr>

                            <th>Nomina foliada</th>
                            <th>Revisar</th>
                        </tr>
                    </thead>

                    <tfoot>
                        <tr>

                            <th class='Filtro'>Id</th>
                            <th class='Filtro'>Expediente</th>

                        </tr>
                    </tfoot>
                </table>

            </div>
        </div>
    </div>






</seccion>





<!-- Modal -->
<div class="modal fade" id="DetallesConNominasFoliadasPagomatico" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title col-11 text-capitalize text-center" id="NombreNominaDelegacion">{}</h5>
                <button type="button" class="close btn-primary" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">


                <!-- Cascaron de tabla para luego llenarla con datos desde la DB -->
                <div class="margenSection">
                    <div class="table-responsive">

                        <div id="TablaDetalleNominas">

                            <table id="NuevaTablaDetallesNominasFoleadas" class='table table-striped table-bordered table-hover'>
                                <caption class="text-uppercase"> Resumen de Nomina </caption>
                                <thead class="tabla">
                                    <tr class="text-center text-uppercase">

                                        <th>Detalles o problemas con nominas </th>
                                    </tr>
                                </thead>


                            </table>

                        </div>
                    </div>
                </div>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>

            </div>
        </div>
    </div>
</div>






<!-- El modal que se muestra en esta pestaña se encuantra en el index ya que hasta que se renderiza se puede usar en esta vista parcial-->






<script>


    function DibujarTablaDetalleNominasFoleadas() {
        $("#TablaDetalleNominas").append(

            "<table id='NuevaTablaDetallesNominasFoleadas'  class='table table-striped display table-bordered table-hover' cellspacing='0'  style='width:100%'>" +
            " <caption class='text-uppercase'>Formas de pago disponible</caption>"
            + "<thead class='tabla'>" +

            "<tr class='text-center text-uppercase'>" +

                "<th>Detalles o problemas con nominas </th>"+
            "</tr>" +
            "</thead>" +
            "</table>"
        );
    };


    function PintarResultadoNominasFoleadas(datos) {

        $('#NuevaTablaDetallesNominasFoleadas').DataTable({
            "ordering": true,
            "info": false,
            "searching": false,
            "paging": false,
            "lengthMenu": [5, 10],
            "language":
            {
                "processing": "Procesando...",
                "lengthMenu": "Mostrar _MENU_ registros",
                "zeroRecords": "No se encontraron resultados",
                "emptyTable": "Ningún dato disponible en esta tabla",
                "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                "search": "Buscar:",
                "info": "Mostrando de _START_ a _END_ de _TOTAL_ entradas",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            "data": "datos[, ]",
            "order": [[1, 'asc']]

        });

    };













    $(document).ready(function () {


        let seleccionNomina = false;
        const checkboxNomina = document.getElementById('checkNomina');
        checkboxNomina.addEventListener('change', function () {
            if (this.checked) {
                document.getElementById('SeleccionarNominaFoliar').style.display = "block";

                $('#checkTodasNominas').prop('checked', false);
                seleccionNomina = true;

            } else {
                document.getElementById('SeleccionarNominaFoliar').style.display = "none";

            }
        });



        let nominasFoliadas = new Array();
        let seleccionTodasNominas = false;
        const checkboxTodasNominas = document.getElementById('checkTodasNominas');
        checkboxTodasNominas.addEventListener('change', function () {
            if (this.checked) {
               document.getElementById('SeleccionarNominaFoliar').style.display = "none";

                $('#checkNomina').prop('checked', false);
                seleccionTodasNominas = true;

                //console.log(seleccionTodasNominas);
            } else {
                document.getElementById('SeleccionarNominaFoliar').style.display = "none";
                seleccionTodasNominas = false;


                //console.log(seleccionTodasNominas);
            }
        });


        let nominaSeleccionadaFoliar = null;
        const SeleccionNomina = document.getElementById("SeleccionarNominaFoliar");
        SeleccionNomina.addEventListener("change",
            function () {

                nominaSeleccionadaFoliar = null;
                nominaSeleccionadaFoliar = this.options[SeleccionNomina.selectedIndex];
                console.log(nominaSeleccionadaFoliar.value);

            }
        );


        ////Captura los cambios de la cuenta bancaria
        //let cuentaSeleccionada = null;
        //const SeleccionCuentaBancaria = document.getElementById("SeleccionarCuentaBancaria");
        //SeleccionCuentaBancaria.addEventListener("change",
        //    function () {

        //        cuentaSeleccionada = null;
        //        cuentaSeleccionada = this.options[SeleccionCuentaBancaria.selectedIndex];
        //        console.log(cuentaSeleccionada.value);

        //    }
        //);





        const Revisar = document.getElementById('Revisar');
        Revisar.addEventListener('click', function () {
           // console.log(checkboxNomina.checked);
            //console.log(checkboxTodasNominas.checked);
            ///console.log(nominaSeleccionadaFoliar);

            document.getElementById('NombreNominaDelegacion').innerHTML = "Vista previa";


            if (checkboxNomina.checked) {

                //console.log(nominaSeleccionadaFoliar);

                if (nominaSeleccionadaFoliar != null) {
                    //Enviar datos al servidor x nomina
                    //
                    //Crear pdf, ponerlo en una carpeta temporal y mostrarle un visualizador para que lo vea y decida que hacer
                    // con el pdf
                    //peticion ajax
                    // nominasFoliadas.push(nominaSeleccionadaFoliar.value);
                    // PintarTablaNominasFoliadas(nominasFoliadas);
                    let EnviarRevicion = "{'IdNomina': '" + nominaSeleccionadaFoliar.value + "'}";

                    MensajeCargando();
                    $.ajax({
                        url: '@Url.Action("RevisarPorIdNomina", "Foliar")',
                        data: EnviarRevicion,
                        type: "POST",
                        contentType: "application/json; charset=utf-8",
                        success: function (response) {

                            //  alert(response);
                            $("example").empty();
                            PDFObject.embed("../Reportes/ReportesPDFSTemporales/RevicionNomina" + nominaSeleccionadaFoliar.value + ".pdf", "#example");
                            $('#ModalPDFVisualizador').modal('show');
                            OcultarMensajeCargando();
                        }
                    });


                } else {

                    MensajeWarningSweet(`Elija un tipo de NOMINA y una CUENTA BANCARIA para continuar`)
                }


            } else if (checkboxTodasNominas.checked) {
                //Enviar datos al servidor para la creacion de PDFs en la vista del usuario

                MensajeCargando();

                let EnviarQuincenaPagomatico = "{'NumeroQuincena': '" +@ViewBag.NumeroQuincena+"'}";


                $.ajax({
                    url: '@Url.Action("RevisarTodasNominas", "Foliar")',
                    data: EnviarQuincenaPagomatico,
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {

                        $("example").empty();
                        PDFObject.embed("../Reportes/ReportesPDFSTemporales/RevicionGeneralNominas"+@ViewBag.NumeroQuincena+".pdf", "#example");
                        $('#ModalPDFVisualizador').modal('show');
                        OcultarMensajeCargando();

                    }
                });
            }


            });


        /*************************************************************************************************/
        /*************************************************************************************************/
        /*************************************************************************************************/


        const Foliar = document.getElementById('RealizarFoliacion');
        Foliar.addEventListener('click', function () {
           // console.log(checkboxNomina.checked);
            //console.log(checkboxTodasNominas.checked);
            ///console.log(nominaSeleccionadaFoliar);

            document.getElementById('NombreNominaDelegacion').innerHTML = "Vista previa";


            const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                    confirmButton: 'btn btn-success',
                    cancelButton: 'btn btn-danger'
                },
                buttonsStyling: false
            })

            swalWithBootstrapButtons.fire({
                title: 'Estas seguro de querer foliar?',
                text: "",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Si, continuar!',
                cancelButtonText: 'No, cancelar!',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {

                     if (checkboxNomina.checked) {

                            //console.log(nominaSeleccionadaFoliar);

                            if (nominaSeleccionadaFoliar != null) {
                                //Enviar datos al servidor x nomina
                                //
                                //Crear pdf, ponerlo en una carpeta temporal y mostrarle un visualizador para que lo vea y decida que hacer
                                // con el pdf
                                //peticion ajax
                                // nominasFoliadas.push(nominaSeleccionadaFoliar.value);
                                // PintarTablaNominasFoliadas(nominasFoliadas);
                                //IdNomina, string NumeroQuincena, int  IdBanco
                                let EnviarRevicion = "{'IdNomina': '"+nominaSeleccionadaFoliar.value+"','NumeroQuincena': '"+@ViewBag.NumeroQuincena+"'}";

                                MensajeCargando();
                                $.ajax({
                                    url: '@Url.Action("FoliarPorIdNominaPagomatico", "Foliar")',
                                    data: EnviarRevicion,
                                    type: "POST",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (response) {

                                        console.log(response);

                                        if (response === true) {
                                            MensajeCorrectoSweet("Se ha foliado la base correctamente ");
                                        }
                                        else {
                                            MensajeErrorSweet("Ocurrio un error en los siguientes empleados:"+ response );
                                        }

                                        OcultarMensajeCargando();
                                    }
                                });


                            } else {

                                MensajeWarningSweet(`Elija un tipo de NOMINA y para continuar`)
                            }


                     } else if (checkboxTodasNominas.checked) {
                            //Enviar datos al servidor para la creacion de PDFs en la vista del usuario

                            MensajeCargando();

                            let EnviarQuincenaPagomatico = "{'NumeroQuincena':'"+@ViewBag.NumeroQuincena+"'}";


                            $.ajax({
                                url: '@Url.Action("FoliarTodasNominas", "Foliar")',
                                data: EnviarQuincenaPagomatico,
                                type: "POST",
                                contentType: "application/json; charset=utf-8",
                                success: function (response) {
                                    console.log(response)

                                    $('#DetallesConNominasFoliadasPagomatico').modal('show');
                                    $('#NuevaTablaDetallesNominasFoleadas').empty();
                                    DibujarTablaDetalleNominasFoleadas();
                                    PintarResultadoNominasFoleadas(response);

                                    OcultarMensajeCargando();



                                    if (response === true) {
                                        MensajeWarningSweet("Se han foliado las nominas correctamente pero asegurese que todas se hayan realizado");

                                    }
                                    else {


                                    

                                        


                                    }

                                  


                                }
                            });
                     }




                } else if (
                    /* Read more about handling dismissals below */
                    result.dismiss === Swal.DismissReason.cancel
                ) {
                    swalWithBootstrapButtons.fire(
                        'Cancelado con exito',
                        'La base esta a salvo sin ninguna modificacion:)',
                        'error'
                    )
                }
            })












            });






    });


</script>
